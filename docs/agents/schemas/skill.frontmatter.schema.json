{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://nanobot.dev/schemas/skill.frontmatter.schema.json",
  "title": "Nanobot Skill Front Matter (Agent Skills compatible)",
  "type": "object",
  "additionalProperties": false,
  "required": ["name", "description"],
  "properties": {
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 64,
      "pattern": "^(?!-)(?!.*--)[a-z0-9-]+(?<!-)$",
      "description": "Must be 1-64 chars, lowercase letters/numbers/hyphens, no leading/trailing hyphen, no consecutive hyphens. Must also match directory name (enforced outside JSON Schema)."
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "maxLength": 1024,
      "description": "Describe what the skill does and when to use it."
    },
    "license": {
      "type": "string",
      "description": "License name or reference to bundled license file."
    },
    "compatibility": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500,
      "description": "Environment requirements (product, packages, network access, etc.)."
    },
    "metadata": {
      "type": "object",
      "description": "Arbitrary key-value mapping.",
      "additionalProperties": {
        "oneOf": [
          { "type": "string" },
          { "type": "number" },
          { "type": "integer" },
          { "type": "boolean" }
        ]
      },
      "default": {}
    },
    "allowed-tools": {
      "type": "string",
      "description": "Space-delimited list of pre-approved tools (experimental). E.g. 'Bash(git:*) Read'."
    },

    "tools": {
      "description": "Nanobot extension: tools visible/available while executing this skill. If omitted, defaults to [\"inherit\"].",
      "type": "array",
      "items": {
        "oneOf": [
          { "type": "string", "enum": ["inherit"] },
          { "type": "string", "minLength": 1 }
        ]
      }
    },

    "tool_approvals": {
      "description": "Nanobot extension: tool approval policy while executing this skill.",
      "type": "object",
      "additionalProperties": false,
      "required": ["default"],
      "properties": {
        "default": {
          "description": "Default authorization behavior. Currently only 'approve' is supported.",
          "type": "string",
          "enum": ["approve"],
          "default": "approve"
        },
        "rules": {
          "description": "Ordered allow rules; first matching rule wins.",
          "type": "array",
          "items": { "$ref": "#/$defs/toolApprovalRule" },
          "default": []
        }
      }
    },

    "skills": {
      "description": "Nanobot extension: skills visible/available while executing this skill. If omitted, defaults to [\"inherit\"].",
      "type": "array",
      "items": {
        "oneOf": [
          { "type": "string", "enum": ["inherit"] },
          { "type": "string", "minLength": 1 }
        ]
      }
    },

    "tasks": {
      "description": "Nanobot extension: tasks visible/available while executing this skill (task IDs are directory paths under .nanobot/tasks).",
      "type": "array",
      "items": { "type": "string", "minLength": 1 },
      "default": ["inherit"]
    },

    "task_approvals": {
      "description": "Nanobot extension: task approval policy while executing this skill.",
      "type": "object",
      "additionalProperties": false,
      "required": ["default"],
      "properties": {
        "default": {
          "description": "Default task authorization behavior. Currently only 'approve' is supported.",
          "type": "string",
          "enum": ["approve"],
          "default": "approve"
        },
        "rules": {
          "description": "Ordered allow rules; first matching rule wins.",
          "type": "array",
          "items": { "$ref": "#/$defs/taskApprovalRule" },
          "default": []
        }
      }
    }
  },

  "$defs": {
    "toolApprovalRule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["tool", "allow"],
      "properties": {
        "tool": {
          "type": "string",
          "minLength": 1,
          "description": "Tool identifier (must match an entry in tools)."
        },
        "allow": { "type": "boolean" },
        "when": {
          "description": "Optional matchers keyed by tool argument name.",
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/matcher" }
        }
      }
    },

    "taskApprovalRule": {
      "type": "object",
      "additionalProperties": false,
      "required": ["task", "allow"],
      "properties": {
        "task": {
          "type": "string",
          "minLength": 1,
          "description": "Task identifier (must match an entry in tasks)."
        },
        "allow": { "type": "boolean" },
        "when": {
          "description": "Optional matchers keyed by task input name.",
          "type": "object",
          "additionalProperties": { "$ref": "#/$defs/matcher" }
        }
      }
    },

    "matcher": {
      "description": "A value matcher for a tool argument key.",
      "oneOf": [
        { "$ref": "#/$defs/equalsMatcher" },
        { "$ref": "#/$defs/inMatcher" },
        { "$ref": "#/$defs/startsWithMatcher" },
        { "$ref": "#/$defs/matchesMatcher" },
        { "$ref": "#/$defs/containsMatcher" },
        { "$ref": "#/$defs/containsAllMatcher" },
        { "$ref": "#/$defs/anyOfMatcher" },
        { "$ref": "#/$defs/allOfMatcher" }
      ]
    },

    "equalsMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["equals"],
      "properties": { "equals": {} }
    },

    "inMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["in"],
      "properties": {
        "in": {
          "type": "array",
          "items": {}
        }
      }
    },

    "startsWithMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["startsWith"],
      "properties": { "startsWith": { "type": "string" } }
    },

    "matchesMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["matches"],
      "properties": { "matches": { "type": "string" } }
    },

    "containsMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["contains"],
      "properties": { "contains": {} }
    },

    "containsAllMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["containsAll"],
      "properties": {
        "containsAll": {
          "type": "array",
          "items": {}
        }
      }
    },

    "anyOfMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["anyOf"],
      "properties": {
        "anyOf": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/matcher" }
        }
      }
    },

    "allOfMatcher": {
      "type": "object",
      "additionalProperties": false,
      "required": ["allOf"],
      "properties": {
        "allOf": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/$defs/matcher" }
        }
      }
    }
  }
}
